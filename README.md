# 子流程最佳实践

函数工作流 + 函数计算产品组合的方式扩展了 Serverless FaaS 的使用场景，使得离线业务场景可以完全的无服务化，真正做到免运维、高弹性。我们也针对最常用的一些场景(如 [音视频处理](<https://yq.aliyun.com/articles/727684>)、[ETL 数据处理](<https://yq.aliyun.com/articles/741105>)、[定时任务](<https://yq.aliyun.com/articles/739119>) 等)提出了一键部署的解决方案。但是在实际的生产环境中，我们往往面临更为复杂的业务流程，这也意味着这些流程有着更为复杂的状态管理、错误处理。函数工作流最新推出了子流程功能，提高了大规模编排任务的可扩展性及易用性。

在大规模编排场景下，我们往往会面临以下常见问题：

- 主流程步骤繁多，数据传递、错误处理流程复杂造成流程描述过长，维护、可读性降低；
- 多个业务流程会共用一些通用的步骤（比如审批流、数据传输步骤等），那么所有流程都需要重复的对通用步骤进行定义。后续的修改需要同时修改多个流程，增大了维护成本及出错的概率；
- 某个流程需要整个流程级别的重试，或无论流程执行成功与否都需要执行某个步骤(类似于 go 语言中的 defer、Python 中的 finally 等)，目前在流程级别无法进行类似定义；
- 为降低人为错误导致的非预期执行造成的损失，我们对单个流程最多event个数（默认5000）和最长执行时间（最长1年）做了限制。这些限制使得某些场景的需求难以被满足。



### 解决方案

子流程的使用方式已在[官网文档](https://help.aliyun.com/document_detail/149829.html)中进行了详细描述，在这里我们主要看下子流程将为上面常见问题带来哪些优化。

###### 主流程简化及流程复用

在写代码时我们都有这种经验：当一个功能不复杂时，我们只需要实现到 main 函数里面就可以了，再复杂一点，或者为了提高可读性，我们往往将功能独立拆分成几个函数，分别实现。如果程序再复杂一点，我们可能会使用一些类来实现代码复用和增加可读性。而如果复杂度到了一定程度，为了提高协作效率，降低维护成本，我们会对系统进行模块的划分。这种经验总结为两个字就是：**抽象**。

在工作流中情况也是类似。当多个流程有相同逻辑时，我们需要做的就是将相同的逻辑"独立"出来。子流程对这类"抽象"提供了支持。通过将通用流程实现为一个单独的流程并定义输入输出规则，我们就可以在多个业务流程中"引用"这个流程进而实现对功能的解耦。

函数工作流提供了对子流程调用的多种方式，比如调用后返回(不等待子流程的执行结果)、同步调用(等待子流程执行完成后，主流程继续)及等待手动回调继续几种模式。这些模式扩展了复用流程的使用方式，以应对不同的业务需要。

###### 流程级别错误处理

目前函数工作流对步骤级别支持捕获错误、重试等操作，但是有些情况下，业务需要流程级别的错误处理。比如，由于某些情况流程执行超时，我们需要对整个流程进行重试；又比如，流程执行无论成功与否，无论在结束时执行到哪里，我们需要流程能够提供一个"无论是否执行成功，都会调用某一固定步骤"的功能。我们可以在这类步骤中进行资源回收、错误处理、甚至是回调通知等机制。

子流程功能为这类需求提供了支持。此时我们将业务的主要处理流程作为子流程，并使用一个主流程来调用它。这样，无论子流程执行什么结果，主流程都能捕获错误输出并对其进行重试，并在后续执行一个固定步骤来实现资源清理、通知等功能。使用这样的一个类似 “fork” 的模式，使得我们对的业务流程执行前后的自动化管理变为可能。



### 最佳实践示例

在本部分我们通过一个简化的业务场景来对上述的解决方案进行展示。

#### 示例场景

业务处理主流程可以是任意工作流流，与其他工作流不同的是该工作流的执行依赖一个审批流的审批通过。这样的逻辑在诸如数据处理、系统运维等场景是十分常见的。在审批流程中，首先会先通知相关用户进行审批，之后等待用户对业务进行判断，并发送是否通过审批的信息。只有通过审批后主工作流程才开始执行，否则直接退出。无论审批流程执行成功与否，我们希望在审批流的最后都能通知流程发起的研发工程师审批的结果。

流程执行图如下：

[流程图](https://github.com/awesome-fnf/subflow-best-practice/blob/master/structure.jpg)

您可从 [github](<https://github.com/awesome-fnf/subflow-best-practice>) 获取本示例的全部代码。代码库中提供了一键搭建本示例全资源的工具，在使用前，请确保您已开通阿里云函数计算、函数工作流服务。

#### 资源准备

一键搭建示例工程使用了阿里云的 [资源编排 ROS](<https://www.aliyun.com/product/ros>) 工具。首先您需要配置好 [ALIYUN CLI 工具](<https://help.aliyun.com/document_detail/139508.html>) ，之后 clone 本项目后工程目录下执行下述命令：

```shell
aliyun ros CreateStack --StackName=stack1 --TemplateBody "$(cat ./ros.yaml)" --region=cn-shenzhen --TimeoutInMinutes=10
```

其中，"StackName" 参数可以使用随机字符串等自定义参数。

执行该命令后，我们将创建以下资源用于本次示例工程：

- ##### 访问控制 - RamRole

  用于提供函数工作流的执行及函数计算的执行角色；

- ##### 函数计算

  您可以从 [audit.py](<https://github.com/awesome-fnf/subflow-best-practice/blob/master/Functions/audit.py>) 获取本文所用的函数。

- ##### 函数工作流

  示例工程会创建两个工作流：

  - [main](<https://github.com/awesome-fnf/subflow-best-practice/blob/master/Flow/main.yaml>): 业务的主处理流程，用于触发一个审批流程，等待审批结果并判断执行情况；
  - [audit](<https://github.com/awesome-fnf/subflow-best-practice/blob/master/Flow/audit.yaml>): 业务审批流程；

  您可以在 [函数工作流控制台](<https://fnf.console.aliyun.com/>) 查看创建结果。

#### 运行示例
进入主流程，点击开始执行，并以下述 json 作为执行输入：
```json
{
  "auditMessage": "please audit"
}
```
运行示例及执行结果：
[运行结果](https://github.com/awesome-fnf/subflow-best-practice/blob/master/subflow-best-practice.gif)


